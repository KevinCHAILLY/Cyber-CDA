# Custom ModSecurity Rules for DVWA Lab
# These rules are designed for educational purposes to demonstrate WAF capabilities

# Rule 1: Detect basic SQL injection patterns
SecRule ARGS "@detectSQLi" \
    "id:1000,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:removeWhitespace,\
    msg:'SQL Injection Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION',\
    severity:'CRITICAL',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}'"

# Rule 2: Detect XSS patterns
SecRule ARGS "@detectXSS" \
    "id:1001,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:removeWhitespace,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'OWASP_CRS/WEB_ATTACK/XSS',\
    severity:'CRITICAL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}'"

# Rule 3: Detect command injection patterns
SecRule ARGS "@pmFromFile unix-shell.data" \
    "id:1002,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:removeWhitespace,\
    msg:'Command Injection Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'OWASP_CRS/WEB_ATTACK/COMMAND_INJECTION',\
    severity:'CRITICAL',\
    setvar:'tx.command_injection_score=+%{tx.critical_anomaly_score}'"

# Rule 4: Detect LFI patterns
SecRule ARGS "@pmFromFile lfi-os-files.data" \
    "id:1003,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:removeWhitespace,\
    msg:'Local File Inclusion (LFI) Attack Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'OWASP_CRS/WEB_ATTACK/LFI',\
    severity:'CRITICAL',\
    setvar:'tx.lfi_score=+%{tx.critical_anomaly_score}'"

# Rule 5: Detect RFI patterns
SecRule ARGS "@pmFromFile rfi.data" \
    "id:1004,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:removeWhitespace,\
    msg:'Remote File Inclusion (RFI) Attack Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'OWASP_CRS/WEB_ATTACK/RFI',\
    severity:'CRITICAL',\
    setvar:'tx.rfi_score=+%{tx.critical_anomaly_score}'"

# Rule 6: Detect PHP code injection
SecRule ARGS "@pm php-function-names.data" \
    "id:1005,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:removeWhitespace,\
    msg:'PHP Code Injection Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}',\
    tag:'OWASP_CRS/WEB_ATTACK/PHP_INJECTION',\
    severity:'CRITICAL',\
    setvar:'tx.php_injection_score=+%{tx.critical_anomaly_score}'"